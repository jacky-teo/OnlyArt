<!DOCTYPE html>
<html>
 
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
 
    <title>Post Content</title>
 
    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Bootstrap libraries -->
    <meta name="viewport" 
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
 
    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css'
       rel='stylesheet'
       integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC'
       crossorigin='anonymous'>
 
    <!-- Latest compiled and minified JavaScript -->
    <script
       src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
 
</head>
 
<body >
        <h1>Upload new File</h1>
    <form method=post enctype=multipart/form-data>
        CreatorID <input type="text" id='creatorID'>
        Description <input type="text" id='description'>
        <input type=file name=file id="file">
        <input type=submit value=Upload id='upload'>
    </form>
    <div id="progress"></div>
    <div id="err"></div>
    <p id="error"></p>
    <!-- Bootstrap Javascript; at the end of the <body> -->
   <script 
       src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
       integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
       crossorigin='anonymous'></script>

<script type="module">
    //Firebase Component
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js"; //initialize firebase app
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-storage.js" //for firebase storage
    import { getDatabase, ref, set, child, update, remove, get, onValue } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-database.js"

    const firebaseConfig = {
        apiKey: "AIzaSyBHAD9cNK6D-EkhcEP2_F0Ap26YQd_3Bnk",
        authDomain: "onlyfence-9eb40.firebaseapp.com",
        databaseURL: "https://onlyfence-9eb40-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "onlyfence-9eb40",
        storageBucket: "onlyfence-9eb40.appspot.com",
        messagingSenderId: "861165223539",
        appId: "1:861165223539:web:a0921e45a09e46b387b406"
    };
    const app = initializeApp(firebaseConfig);
    

    // anonymous async function 
    // - using await requires the function that calls it to be async
    $('#upload').click(async() => { 
        var creatorID = document.getElementById('creatorID'),
        description=document.getElementById('description'),
        file = $('#file').prop('files')[0],
        pbar = document.getElementById('progress'),
        fileName = file.name,
        reader = new FileReader()
        reader.readAsDataURL(file)

        alert(creatorID.value)
        alert(description.value)
        alert(fileName)
        // Upload to firebase
        if (!file) {
            document.getElementById('err').innerText = "No files selected"
            return
        }

        // Declare Meta Data
        const metaData = {
            contentType: file.type
        }

        //Firebase Storage
        const storage = getStorage();
        
        //Point to firebase storage that u want to upload in
        const storageRef = sRef(storage, creatorID.value + "/" + fileName);
        const UploadTask = uploadBytesResumable(storageRef, file, metaData);
        console.log(file)
        UploadTask.on('state-changed', (snapshot) => {
             var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
             pbar.innerHTML = "Upload "+progress +"%"
             console.log(progress)
        },
        (error) => {
            alert("Upload Failed Please Try Again"); // Failed to upload Errror
        },
        ()=>{
            getDownloadURL(UploadTask.snapshot.ref).then((downloadURL)=>{
                alert(downloadURL)
            })
        });
    })

    </script>      
</body>
 
</html>